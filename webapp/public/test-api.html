<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Test</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
            background: #1a1a2e;
            color: white;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
        }
        button {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            background: rgba(0,0,0,0.3);
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .success { color: #4CAF50; }
        .error { color: #f44336; }
    </style>
</head>
<body>
    <h1>API Test Page</h1>
    
    <div class="test-section">
        <h2>Telegram WebApp Info</h2>
        <div id="tgInfo" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>Test Tasks API</h2>
        <button onclick="testTasks()">Test /api/tasks/my</button>
        <button onclick="testTasksWithTest()">Test /api/tasks/my?test=1</button>
        <div id="tasksResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>Test Employees API</h2>
        <button onclick="testEmployees()">Test /api/employees</button>
        <button onclick="testEmployeesWithTest()">Test /api/employees?test=1</button>
        <div id="employeesResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>Test Database Status</h2>
        <button onclick="testStatus()">Test /api/debug/status</button>
        <div id="statusResult" class="result"></div>
    </div>

    <script>
        const tg = window.Telegram?.WebApp;
        
        // Show Telegram info
        document.getElementById('tgInfo').innerHTML = JSON.stringify({
            initData: tg?.initData ? 'Present (' + tg.initData.length + ' chars)' : 'Missing',
            initDataUnsafe: tg?.initDataUnsafe || 'Not available',
            platform: tg?.platform || 'Unknown',
            version: tg?.version || 'Unknown',
            isExpanded: tg?.isExpanded,
            viewportHeight: tg?.viewportHeight,
            viewportStableHeight: tg?.viewportStableHeight
        }, null, 2);
        
        async function testTasks() {
            const result = document.getElementById('tasksResult');
            result.innerHTML = 'Loading...';
            
            try {
                const headers = {};
                if (tg?.initData) {
                    headers['X-Telegram-Init-Data'] = tg.initData;
                }
                
                const response = await fetch('/api/tasks/my', { headers });
                const data = await response.json();
                
                result.innerHTML = `Status: ${response.status}\n`;
                result.innerHTML += `Tasks count: ${data.length || 0}\n`;
                result.innerHTML += JSON.stringify(data.slice(0, 2), null, 2);
                result.className = 'result ' + (response.ok ? 'success' : 'error');
            } catch (error) {
                result.innerHTML = 'Error: ' + error.message;
                result.className = 'result error';
            }
        }
        
        async function testTasksWithTest() {
            const result = document.getElementById('tasksResult');
            result.innerHTML = 'Loading...';
            
            try {
                const response = await fetch('/api/tasks/my?test=1');
                const data = await response.json();
                
                result.innerHTML = `Status: ${response.status}\n`;
                result.innerHTML += `Tasks count: ${data.length || 0}\n`;
                result.innerHTML += JSON.stringify(data.slice(0, 2), null, 2);
                result.className = 'result ' + (response.ok ? 'success' : 'error');
            } catch (error) {
                result.innerHTML = 'Error: ' + error.message;
                result.className = 'result error';
            }
        }
        
        async function testEmployees() {
            const result = document.getElementById('employeesResult');
            result.innerHTML = 'Loading...';
            
            try {
                const headers = {};
                if (tg?.initData) {
                    headers['X-Telegram-Init-Data'] = tg.initData;
                }
                
                const response = await fetch('/api/employees', { headers });
                const data = await response.json();
                
                result.innerHTML = `Status: ${response.status}\n`;
                result.innerHTML += `Employees count: ${data.length || 0}\n`;
                result.innerHTML += JSON.stringify(data.slice(0, 2), null, 2);
                result.className = 'result ' + (response.ok ? 'success' : 'error');
            } catch (error) {
                result.innerHTML = 'Error: ' + error.message;
                result.className = 'result error';
            }
        }
        
        async function testEmployeesWithTest() {
            const result = document.getElementById('employeesResult');
            result.innerHTML = 'Loading...';
            
            try {
                const response = await fetch('/api/employees?test=1');
                const data = await response.json();
                
                result.innerHTML = `Status: ${response.status}\n`;
                result.innerHTML += `Employees count: ${data.length || 0}\n`;
                result.innerHTML += JSON.stringify(data.slice(0, 2), null, 2);
                result.className = 'result ' + (response.ok ? 'success' : 'error');
            } catch (error) {
                result.innerHTML = 'Error: ' + error.message;
                result.className = 'result error';
            }
        }
        
        async function testStatus() {
            const result = document.getElementById('statusResult');
            result.innerHTML = 'Loading...';
            
            try {
                const response = await fetch('/api/debug/status');
                const data = await response.json();
                
                result.innerHTML = JSON.stringify(data, null, 2);
                result.className = 'result ' + (response.ok ? 'success' : 'error');
            } catch (error) {
                result.innerHTML = 'Error: ' + error.message;
                result.className = 'result error';
            }
        }
        
        // Auto-expand Telegram WebApp
        if (tg) {
            tg.ready();
            tg.expand();
        }
    </script>
</body>
</html>